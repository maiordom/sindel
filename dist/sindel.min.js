"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}();!function(e,t,s){var i="sindel",n={tmpl:'<div class="'+i+" "+i+'_active" tabindex="1">\n        <div class="'+i+'__box">\n            <div class="'+i+'__current-text"></div>\n            <div class="'+i+'__arrow"></div>\n        </div>\n        <div class="'+i+'__drop">\n            <input class="'+i+'__search" type=и"text" tabindex="-1" />\n            <ul class="'+i+'__options"></ul>\n        </div>\n    </div>',doTmpl:function(e){var s=document.createElement("div");return s.innerHTML=e,t(s.firstChild)},forEach:function(e,t,s){for(var i=0,n=e.length;n>i&&t.call(s,e[i],i)!==!1;i++);},each:function(e,t,s){for(var i=0,n=e.length;n>i&&t.call(s,e.eq(i),i)!==!1;i++);},toArray:function(e){var t=[];return n.forEach(e,function(e){t.push(e)}),t},cacheObjects:function(e){var s=e,c=n.doTmpl(n.tmpl),o=n.toArray(s.get(0).getElementsByTagName("OPTION")),h=s.get(0).selectedIndex,a={ctx:s,options:o,selected:t(o[h>=0?h:0])},l={ctx:c,search:c.find("."+i+"__search"),box:c.find("."+i+"__box"),drop:c.find("."+i+"__drop"),currentText:c.find("."+i+"__current-text"),list:c.find("."+i+"__options"),matches:t(),items:t(),selected:t(),hovered:t()};return c.insertBefore(s[0]),c.append(s[0]),{select:a,chosen:l}},getListTmp:function(e,t){var s="";return n.forEach(e,function(e){s+='<li class="'+i+'__item b-hidden" data-original-index="'+t+'" data-index="'+t+'">'+e.innerHTML+"</li>",t++}),s},setParams:function(e){var s={listOverflow:!0};return t.extend(s,e)}},c=function(){function e(t,s){return _classCallCheck(this,e),this.init(t,s),{destroy:this.destroy.bind(this),update:this.update.bind(this)}}return _createClass(e,[{key:"init",value:function(e,s){this.doc=t(document),this.isOpen=null,this.isMouseleave=!1,this.params=n.setParams(s);var i=n.cacheObjects(e);this.chosen=i.chosen,this.select=i.select,this.render(),this.selectInitialItem(),this.closeWidget(),this.bindEvents()}},{key:"render",value:function(){this.chosen.list.html(n.getListTmp(this.select.options,0)),this.chosen.items=this.chosen.ctx.find("."+i+"__item"),this.select.ctx.attr("tabindex",-1),this.chosen.search.attr("placeholder","или введите другой"),this.select.ctx.addClass("b-hidden"),this.params.listOverflow&&this.chosen.list.addClass(i+"__list_overflow")}},{key:"selectInitialItem",value:function(){var e=void 0;this.select.selected.length?(e=this.select.selected.html(),n.each(this.chosen.items,function(t,s){return t.html()===e?(this.selectItem(t),!1):void 0},this)):this.selectByIndex(0)}},{key:"selectByIndex",value:function(e){this.selectItem(this.chosen.items.eq(e))}},{key:"update",value:function(){var e=this.select.ctx.get(0).selectedIndex;this.selectByIndex(e)}},{key:"bindEvents",value:function(){this.chosen.search.on("keydown",this.onSearchKeydown.bind(this)),this.chosen.search.on("keyup",this.onSearchKeyup.bind(this)),this.chosen.search.on("blur",this.onSearchBlur.bind(this)),this.chosen.ctx.on("mouseover",this.onItemMouseover.bind(this)),this.chosen.ctx.on("mouseout",this.onItemMouseout.bind(this)),this.chosen.ctx.on("mouseenter",this.onCtxMouseenter.bind(this)),this.chosen.ctx.on("mouseleave",this.onCtxMouseleave.bind(this)),this.chosen.box.on("click",this.onBoxClick.bind(this)),this.chosen.ctx.on("click",this.onItemClick.bind(this)),this.chosen.box.on("mousedown",this.onBoxMousedown.bind(this)),this.chosen.ctx.on("focus",this.onCtxFocus.bind(this)),this.chosen.ctx.on("focusout",this.onCtxFocusout.bind(this))}},{key:"onCtxFocus",value:function(){this.chosen.ctx.addClass(i+"_focus")}},{key:"onCtxFocusout",value:function(){this.chosen.ctx.removeClass(i+"_focus")}},{key:"onCtxMouseenter",value:function(){this.isMouseleave=!1,this.chosen.ctx.addClass(i+"_hover")}},{key:"onCtxMouseleave",value:function(){this.isMouseleave=!0,this.isOpen?this.chosen.search.focus():null,this.chosen.ctx.removeClass(i+"_hover")}},{key:"onSearchKeydown",value:function(e){if(~[27,38,40,13].indexOf(e.keyCode)&&!this.isOpen)return this.chosen.ctx.removeClass(i+"_focus"),void this.openWidget();switch(e.keyCode){case 27:this.onEscClose();break;case 38:this.navigate(-1);break;case 40:this.navigate(1);break;case 13:this.selectItemByInter()}}},{key:"onEscClose",value:function(){this.closeWidget()}},{key:"onSearchKeyup",value:function(e){switch(e.keyCode){case 27:case 38:case 40:case 13:break;default:this.findAndSelectMatches()}}},{key:"onBoxMousedown",value:function(){return this.chosen.ctx.removeClass(i+"_focus"),this.chosen.ctx.addClass(i+"_pressed"),this.doc.off("click.chosen"),this.doc.on("click.chosen",this.onDocClick.bind(this)),!1}},{key:"onBoxClick",value:function(e){this.isOpen?this.closeWidget():this.openWidget()}},{key:"onDocClick",value:function(){this.isMouseleave&&(this.doc.off("click.chosen"),this.chosen.ctx.removeClass(i+"_focus"),this.closeWidget()),this.chosen.ctx.removeClass(i+"_pressed")}},{key:"onSearchBlur",value:function(){this.isMouseleave&&this.closeWidget(),this.chosen.ctx.removeClass(i+"_focus")}},{key:"onItemClick",value:function(e){var s=t(e.target);s.hasClass(i+"__item")&&(this.selectItem(s),this.closeWidget(),e.stopPropagation())}},{key:"onItemMouseover",value:function(e){var s=t(e.target);return!s.hasClass(i+"__item")||s.hasClass("b-hidden")?!1:void(s.hasClass(i+"__item_active")||(this.unselect(),this.chosen.hovered=s,s.addClass(i+"__item_active")))}},{key:"onItemMouseout",value:function(e){t(e.target).hasClass(i+"__item_active")&&this.unselect()}},{key:"findAndSelectMatches",value:function(){this.chosen.list.get(0).scrollTop=0,this.chosen.search.val()?this.findSearchMatches():this.showItems(),this.chosen.matches.length?this.onItemMouseover({target:this.chosen.matches[0]}):this.unselect()}},{key:"unselect",value:function(){this.chosen.selected.removeClass(i+"__item_active"),this.chosen.hovered.removeClass(i+"__item_active")}},{key:"getCurrentItem",value:function(){return this.chosen.hovered.hasClass(i+"__item_active")?this.chosen.hovered:this.chosen.selected.hasClass(i+"__item_active")?this.chosen.selected:null}},{key:"selectItemByInter",value:function(){var e=this.getCurrentItem();e&&this.onItemClick(new t.Event("click",{target:e.get(0)}))}},{key:"getIndex",value:function(e){var t=this.getCurrentItem();return t?parseInt(t.attr("data-index"),10):parseInt(this.chosen.selected.attr("data-index"),10)-1}},{key:"navigate",value:function(e){var t=this.getIndex(),s=t+e,n=this.chosen.matches.length,c=void 0;this.unselect(),-1>=s?c=this.chosen.matches.eq(n-1).addClass(i+"__item_active"):n-1>=s?c=this.chosen.matches.eq(s).addClass(i+"__item_active"):s>=n&&(c=this.chosen.matches.eq(0).addClass(i+"__item_active")),this.scrollTo(c.get(0)),this.chosen.hovered=c}},{key:"scrollTo",value:function(e){var t=this.chosen.list.get(0),s=t.offsetHeight,i=t.scrollTop,n=s+i,c=e.offsetTop,o=c+e.offsetHeight;o>=n?t.scrollTop=o-s>0?o-s:0:i>c&&(t.scrollTop=c)}},{key:"findSearchMatches",value:function(){var e=this.chosen.search.val().toLocaleLowerCase(),s=this.chosen.items,i=0,c=void 0,o=[];n.each(s,function(t,s){c=t.html().toLowerCase().search(e),-1===c?t.removeAttr("data-index").addClass("b-hidden"):c>=0&&(o.push(t.get(0)),t.removeClass("b-hidden").attr("data-index",i++))},this),this.chosen.matches=t(o)}},{key:"showItems",value:function(){n.each(this.chosen.items,function(e,t){e.removeClass("b-hidden").attr("data-index",t)},this),this.chosen.matches=this.chosen.items}},{key:"openWidget",value:function(){this.isOpen=!0,this.chosen.ctx.removeClass(i+"_focus").addClass(i+"_active"),this.showItems(),this.chosen.search.val(""),this.chosen.search.focus(),this.chosen.hovered.removeClass(i+"__item_active"),this.chosen.selected=this.chosen.selected.hasClass("b-hidden")?this.chosen.items.eq(0):this.chosen.selected,this.chosen.selected.addClass(i+"__item_active"),this.scrollTo(this.chosen.selected.get(0))}},{key:"closeWidget",value:function(){this.isOpen=!1,this.chosen.ctx.removeClass(i+"_active"),this.chosen.ctx.removeClass(i+"_hover")}},{key:"selectItem",value:function(e){this.unselect(),this.chosen.selected.removeClass(i+"__item_selected"),this.chosen.selected=e.addClass(i+"__item_selected"),this.chosen.currentText.html(this.chosen.selected.html()),this.select.ctx.get(0).selectedIndex=parseInt(this.chosen.selected.attr("data-original-index"),10)}},{key:"destroy",value:function(){this.doc.off("click.chosen"),this.select.ctx.removeClass("b-hidden"),this.chosen.ctx.remove()}}]),e}();t.fn.sindel=function(e){n.each(this,function(t){t.data(""+i)?console.log(i+" already init: ",t,e):t.data(""+i,new c(t,e||{}))},this)}}(window,jQuery,void 0);