"use strict";function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,s){for(var t=0;t<s.length;t++){var i=s[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(s,t,i){return t&&e(s.prototype,t),i&&e(s,i),s}}();!function(e,s,t){var i="sindel",n={tmpl:'<div class="'+i+" "+i+'_active">\n        <div class="'+i+'__box">\n            <div class="'+i+'__current-text"></div>\n            <div class="'+i+'__arrow"></div>\n        </div>\n        <div class="'+i+'__drop">\n            <div class="'+i+'__drop-inner">\n                <ul class="'+i+'__majors"></ul>\n                <input class="'+i+'__search" type="text" tabindex="-1" />\n                <ul class="'+i+'__minors"></ul>\n            </div>\n        </div>\n    </div>',doTmpl:function(e){var t=document.createElement("div");return t.innerHTML=e,s(t.firstChild)},forEach:function(e,s,t){for(var i=0,n=e.length;n>i&&s.call(t,e[i],i)!==!1;i++);},each:function(e,s,t){for(var i=0,n=e.length;n>i&&s.call(t,e.eq(i),i)!==!1;i++);},toArray:function(e){var s=[];return n.forEach(e,function(e,t){s.push(e)}),s},cacheObjects:function(e){var t=e,o=n.doTmpl(n.tmpl),c=n.toArray(t.get(0).getElementsByTagName("OPTION")),h=t.get(0).selectedIndex,a={ctx:t,options:c,selected:s(c[h>=0?h:0])},r={ctx:o,search:o.find("."+i+"__search"),box:o.find("."+i+"__box"),drop:o.find("."+i+"__drop"),currentText:o.find("."+i+"__current-text"),majorsList:o.find("."+i+"__majors"),minorsList:o.find("."+i+"__minors"),newItems:s(),matches:s(),items:s(),selected:s(),hovered:s()};return o.insertBefore(t[0]),o.append(t[0]),{select:a,chosen:r}},getListTmp:function(e,s){var t="";return n.forEach(e,function(e,n){t+='<li class="'+i+'__item b-hidden" data-original-index="'+s+'" data-index="'+s+'">'+e.innerHTML+"</li>",s++}),t},setParams:function(e){var t={majorsCount:0,minorsListOverflow:!0,searchLimit:null};return s.extend(t,e)}},o=function(){function e(s,t){return _classCallCheck(this,e),this.init(s,t),{destroy:this.destroy.bind(this),update:this.update.bind(this)}}return _createClass(e,[{key:"init",value:function(e,t){this.doc=s(document),this.isOpen=null,this.isMouseleave=!1,this.params={},this.select={},this.chosen={},this.params=n.setParams(t);var i=n.cacheObjects(e);this.chosen=i.chosen,this.select=i.select,this.render(this.replaceItems()),this.selectInitialItem(),this.closeWidget(),this.bindEvents()}},{key:"replaceItems",value:function(){var e=this.select.options.slice(0,this.params.majorsCount),s=this.select.options.slice(this.params.majorsCount);return{majors:e,minors:s}}},{key:"render",value:function(e){this.chosen.majorsList.html(n.getListTmp(e.majors,0)),this.chosen.minorsList.html(n.getListTmp(e.minors,e.majors.length)),this.chosen.items=this.chosen.ctx.find("."+i+"__item"),this.select.ctx.attr("tabindex",-1),this.chosen.search.attr("placeholder","или введите другой"),this.select.ctx.addClass("b-hidden"),this.params.minorsListOverflow&&this.chosen.minorsList.addClass(i+"__minors_overflow"),this.params.searchLimit||(this.params.searchLimit=e.minors.length)}},{key:"selectInitialItem",value:function(){var e=void 0;this.select.selected.length?(e=this.select.selected.html(),n.each(this.chosen.items,function(s,t){return s.html()===e?(this.selectItem(s),!1):void 0},this)):this.selectByIndex(0)}},{key:"selectByIndex",value:function(e){this.selectItem(this.chosen.items.eq(e))}},{key:"update",value:function(){var e=this.select.ctx.get(0).selectedIndex;this.selectByIndex(e)}},{key:"bindEvents",value:function(){this.chosen.search.on("keydown",this.onSearchKeydown.bind(this)),this.chosen.search.on("keyup",this.onSearchKeyup.bind(this)),this.chosen.search.on("blur",this.onSearchBlur.bind(this)),this.chosen.ctx.on("mouseover",this.onItemMouseover.bind(this)),this.chosen.ctx.on("mouseout",this.onItemMouseout.bind(this)),this.chosen.ctx.on("mouseenter",this.onCtxMouseenter.bind(this)),this.chosen.ctx.on("mouseleave",this.onCtxMouseleave.bind(this)),this.chosen.ctx.on("click",this.onCtxClick.bind(this)),this.chosen.ctx.on("click",this.onItemClick.bind(this)),this.chosen.box.on("mousedown",this.onBoxMousedown.bind(this)),this.chosen.box.on("focus",this.onBoxFocus.bind(this))}},{key:"onBoxFocus",value:function(){this.chosen.ctx.addClass(i+"_focus"),this.chosen.search.focus()}},{key:"onCtxMouseenter",value:function(){this.isMouseleave=!1,this.chosen.ctx.addClass(i+"_hover")}},{key:"onCtxMouseleave",value:function(){this.isMouseleave=!0,this.isOpen?this.chosen.search.focus():null,this.chosen.ctx.removeClass(i+"_hover")}},{key:"onSearchKeydown",value:function(e){if(~[27,38,40,13].indexOf(e.keyCode)&&!this.isOpen)return this.chosen.ctx.removeClass(i+"_focus"),void this.openWidget();switch(e.keyCode){case 27:this.onEscClose();break;case 38:this.navigate(-1);break;case 40:this.navigate(1);break;case 13:this.selectItemByInter()}}},{key:"onEscClose",value:function(){this.closeWidget()}},{key:"onSearchKeyup",value:function(e){switch(e.keyCode){case 27:case 38:case 40:case 13:break;default:this.findAndSelectMatches()}}},{key:"onBoxMousedown",value:function(){return this.chosen.ctx.removeClass(i+"_focus"),this.chosen.ctx.addClass(i+"_pressed"),this.doc.off("click.chosen"),this.doc.on("click.chosen",this.onDocClick.bind(this)),!1}},{key:"onCtxClick",value:function(){this.displayDrop()}},{key:"onDocClick",value:function(){this.isMouseleave&&(this.doc.off("click.chosen"),this.chosen.ctx.removeClass(i+"_focus"),this.closeWidget()),this.chosen.ctx.removeClass(i+"_pressed")}},{key:"onSearchBlur",value:function(){this.isMouseleave&&this.closeWidget(),this.chosen.ctx.removeClass(i+"_focus")}},{key:"onItemClick",value:function(e){var t=s(e.target);t.hasClass(i+"__item")&&(this.selectItem(t),this.closeWidget(),e.stopPropagation())}},{key:"onItemMouseover",value:function(e){var t=s(e.target);return!t.hasClass(i+"__item")||t.hasClass("b-hidden")?!1:void(t.hasClass(i+"__item_active")||(this.unselect(),this.chosen.hovered=t,t.addClass(i+"__item_active")))}},{key:"onItemMouseout",value:function(e){s(e.target).hasClass(i+"__item_active")&&this.unselect()}},{key:"findAndSelectMatches",value:function(){this.chosen.minorsList.get(0).scrollTop=0,this.chosen.search.val()?this.findSearchMatches():this.showItems(),this.chosen.matches.length?this.onItemMouseover({target:this.chosen.matches[0]}):this.unselect()}},{key:"unselect",value:function(){this.chosen.selected.removeClass(i+"__item_active"),this.chosen.hovered.removeClass(i+"__item_active")}},{key:"getCurrentItem",value:function(){return this.chosen.hovered.hasClass(i+"__item_active")?this.chosen.hovered:this.chosen.selected.hasClass(i+"__item_active")?this.chosen.selected:null}},{key:"selectItemByInter",value:function(){var e=this.getCurrentItem();e&&this.onItemClick(new s.Event("click",{target:e.get(0)}))}},{key:"getIndex",value:function(e){var s=this.getCurrentItem();return s?parseInt(s.attr("data-index"),10):parseInt(this.chosen.selected.attr("data-index"),10)-1}},{key:"navigate",value:function(e){var s=this.getIndex(),t=s+e,n=this.chosen.newItems.length,o=void 0;this.unselect(),-1>=t?o=this.chosen.newItems.eq(n-1).addClass(i+"__item_active"):n-1>=t?o=this.chosen.newItems.eq(t).addClass(i+"__item_active"):t>=n&&(o=this.chosen.newItems.eq(0).addClass(i+"__item_active")),this.scrollTo(o.get(0)),this.chosen.hovered=o}},{key:"scrollTo",value:function(e){var s=this.chosen.minorsList.get(0),t=s.offsetHeight,i=s.scrollTop,n=t+i,o=e.offsetTop,c=o+e.offsetHeight;c>=n?s.scrollTop=c-t>0?c-t:0:i>o&&(s.scrollTop=o)}},{key:"findSearchMatches",value:function(){var e=this.chosen.search.val().toLocaleLowerCase(),s=this.chosen.items.slice(this.params.majorsCount),t=this.params.majorsCount,i=void 0,o=[];this.chosen.newItems=this.chosen.items.slice(0,this.params.majorsCount),n.each(s,function(s,n){i=s.html().toLowerCase().search(e),o.length>=this.params.searchLimit||-1===i?s.removeAttr("data-index").addClass("b-hidden"):i>=0&&(o.push(s.get(0)),s.removeClass("b-hidden").attr("data-index",t++))},this),this.chosen.matches=o,this.chosen.newItems=this.chosen.newItems.add(o)}},{key:"showItems",value:function(){n.each(this.chosen.items,function(e,s){s<this.params.majorsCount+this.params.searchLimit?e.removeClass("b-hidden").attr("data-index",s):e.removeAttr("data-index").addClass("b-hidden")},this),this.chosen.newItems=this.chosen.items.slice(0,this.params.majorsCount+this.params.searchLimit),this.chosen.matches=this.chosen.items.slice(this.params.majorsCount).get()}},{key:"displayDrop",value:function(){this.isOpen?this.closeWidget():this.openWidget()}},{key:"openWidget",value:function(){this.isOpen=!0,this.chosen.ctx.removeClass(i+"_focus").addClass(i+"_active"),this.showItems(),this.chosen.search.val(""),this.chosen.search.focus(),this.chosen.hovered.removeClass(i+"__item_active"),this.chosen.selected=this.chosen.selected.hasClass("b-hidden")?this.chosen.items.eq(0):this.chosen.selected,this.chosen.selected.addClass(i+"__item_active"),this.scrollTo(this.chosen.selected.get(0))}},{key:"closeWidget",value:function(){this.isOpen=!1,this.chosen.ctx.removeClass(i+"_active"),this.chosen.ctx.removeClass(i+"_hover")}},{key:"selectItem",value:function(e){this.unselect(),this.chosen.selected.removeClass(i+"__item_selected"),this.chosen.selected=e.addClass(i+"__item_selected"),this.chosen.currentText.html(this.chosen.selected.html()),this.select.ctx.get(0).selectedIndex=parseInt(this.chosen.selected.attr("data-original-index"),10)}},{key:"destroy",value:function(){this.doc.off("click.chosen"),this.select.ctx.removeClass("b-hidden"),this.chosen.ctx.remove()}}]),e}();s.fn.sindel=function(e){n.each(this,function(s){s.data(""+i)?console.log(i+" already init: ",s,e):s.data(""+i,new o(s,e||{}))},this)}}(window,jQuery,void 0);